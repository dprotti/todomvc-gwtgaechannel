<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><title>ToDoCell.java</title><link href="../../../../css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="../../../../css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/><link href="../../../../css/atlassian-docco.css" rel="stylesheet" type="text/css"/><link href="../../../../gwttodo.css" rel="stylesheet" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternate stylesheet" class="codebrush light" title="IDEA" href="http://yandex.st/highlightjs/6.2/styles/idea.min.css"/><link rel="alternate stylesheet" class="codebrush light" title="Google Code" href="http://yandex.st/highlightjs/6.2/styles/googlecode.min.css"/><link rel="alternate stylesheet" class="codebrush light" title="GitHub" href="http://yandex.st/highlightjs/6.2/styles/github.min.css"/><link rel="alternate stylesheet" class="codebrush light" title="Visual Studio" href="http://yandex.st/highlightjs/6.2/styles/vs.min.css"/><link rel="alternate stylesheet" class="codebrush light" title="Magula" href="http://yandex.st/highlightjs/6.2/styles/magula.min.css"/><link rel="stylesheet" class="codebrush dark" title="Zenburn" href="http://yandex.st/highlightjs/6.2/styles/zenburn.min.css"/><link rel="alternate stylesheet" class="codebrush dark" title="Arta" href="http://yandex.st/highlightjs/6.2/styles/arta.min.css"/><link rel="alternate stylesheet" class="codebrush dark" title="Monokai" href="http://yandex.st/highlightjs/6.2/styles/monokai.min.css"/><link rel="alternate stylesheet" class="codebrush dark" title="IR Black" href="http://yandex.st/highlightjs/6.2/styles/ir_black.min.css"/><link rel="alternate stylesheet" class="codebrush dark" title="Solarized Dark" href="http://yandex.st/highlightjs/6.2/styles/solarized_dark.min.css"/><script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script><script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script><script type="text/javascript" src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script><script type="text/javascript" src="../../../../js/jquery.cookie.js"></script><script type="text/javascript" src="../../../../js/bootstrap.min.js"></script><!-- Use our own attlassian-docco.js file to set Zenburn as default theme --><script type="text/javascript" src="../../../../gwttodo-atlassian-docco.js"></script></head><body><div class="navbar navbar-fixed-top"><div class="navbar-inner"><div class="container-fluid"><a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><div class="brand"><a href=../../../../index.html>GWT+GAE TodoMVC</a><span class="source-filename">ToDoCell.java</span></div><div class="nav-collapse"><ul class="nav"><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Index <b class="caret"></b></a><ul class="dropdown-menu"><div class="nav-header">client</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/client/command/CommandDeserializerImpl.java.html">CommandDeserializerImpl.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/ModelCache.java.html">ModelCache.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/Presenter.java.html">Presenter.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/ToDoCell.java.html">ToDoCell.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/ToDoGinModule.java.html">ToDoGinModule.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/ToDoPresenter.java.html">ToDoPresenter.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/ToDoView.java.html">ToDoView.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/View.java.html">View.java</a></div></nav><div class="nav-header">client.command</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/client/command/ClientCommandExecutor.java.html">ClientCommandExecutor.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/command/CommandController.java.html">CommandController.java</a></div></nav><div class="nav-header">client.command.todo</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/client/command/todo/ClientToDoCommandExecutor.java.html">ClientToDoCommandExecutor.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/command/todo/ClientToDoListCommandExecutor.java.html">ClientToDoListCommandExecutor.java</a></div></nav><div class="nav-header">client.events</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/client/events/AddOrRemoveEvent.java.html">AddOrRemoveEvent.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/events/ToDoListAddOrRemoveEvent.java.html">ToDoListAddOrRemoveEvent.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/events/ToDoListUpdatedEvent.java.html">ToDoListUpdatedEvent.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/client/events/ToDoUpdatedEvent.java.html">ToDoUpdatedEvent.java</a></div></nav><div class="nav-header">server</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/server/GwtRpcSerializer.java.html">GwtRpcSerializer.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/server/ToDoServerInjector.java.html">ToDoServerInjector.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/server/ToDoServerModule.java.html">ToDoServerModule.java</a></div></nav><div class="nav-header">server.command</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/server/command/CommandSerializer.java.html">CommandSerializer.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/server/command/ServerCommandExecutor.java.html">ServerCommandExecutor.java</a></div></nav><div class="nav-header">server.command.todo</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/server/command/todo/ServerToDoCommandExecutor.java.html">ServerToDoCommandExecutor.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/server/command/todo/ServerToDoListCommandExecutor.java.html">ServerToDoListCommandExecutor.java</a></div></nav><div class="nav-header">server.service</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/server/service/CommandServiceImpl.java.html">CommandServiceImpl.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/server/service/ToDoServiceImpl.java.html">ToDoServiceImpl.java</a></div></nav><div class="nav-header">server.servlet</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/server/servlet/ChannelConnectionsHandler.java.html">ChannelConnectionsHandler.java</a></div></nav><div class="nav-header">shared.command</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/BaseCommand.java.html">BaseCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/BulkSetterCommand.java.html">BulkSetterCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/Command.java.html">Command.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/CommandExecutor.java.html">CommandExecutor.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/CommandSerialization.java.html">CommandSerialization.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/SetterCommand.java.html">SetterCommand.java</a></div></nav><div class="nav-header">shared.command.todo</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/AddOrRemoveToDoCommand.java.html">AddOrRemoveToDoCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/RemoveCompletedToDoListCommand.java.html">RemoveCompletedToDoListCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/SetCompletedToDoCommand.java.html">SetCompletedToDoCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/SetCompletedToDoListCommand.java.html">SetCompletedToDoListCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/SetTitleToDoCommand.java.html">SetTitleToDoCommand.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/ToDoCommandExecutor.java.html">ToDoCommandExecutor.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/command/todo/ToDoListCommandExecutor.java.html">ToDoListCommandExecutor.java</a></div></nav><div class="nav-header">shared.model</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/model/HasID.java.html">HasID.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/model/IdentifiableCollection.java.html">IdentifiableCollection.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/model/ToDo.java.html">ToDo.java</a></div></nav><div class="nav-header">shared.service</div><nav><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/service/CommandService.java.html">CommandService.java</a></div><div class="source-file-link"><a href="../../../../java/com/todomvc/shared/service/ToDoService.java.html">ToDoService.java</a></div></nav></ul></li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Theme <b class="caret"></b></a><ul id="themeDropdown" class="dropdown-menu"></ul></li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Layout <b class="caret"></b></a><ul class="dropdown-menu"><li class="active"><a href="#">Horizontal</a></li><li><a href="../../../../../vertical/java\com\todomvc\client\ToDoCell.java.html">Vertical</a></li></ul></li></ul></div><!--/.nav-collapse --></div></div></div><div class="container-fluid docco-container"><div id="section-0" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-0">0</a></span><div class="doctext hidden-doc"></div></div><div class="span6 code"><div class="hidden-code-line">------------------<a href="javascript:void(0)" class="hidden-code-toggle" index="0">Show Code (<span class="linecount"></span> lines)</a>------------------</div><pre class="hidden-code"><code class="java">package com.todomvc.client;

import static com.google.common.base.Preconditions.checkNotNull;

import java.util.Date;

import com.google.gwt.cell.client.AbstractCell;
import com.google.gwt.cell.client.ValueUpdater;
import com.google.gwt.core.client.GWT;
import com.google.gwt.dom.client.DivElement;
import com.google.gwt.dom.client.Element;
import com.google.gwt.dom.client.EventTarget;
import com.google.gwt.dom.client.InputElement;
import com.google.gwt.dom.client.NativeEvent;
import com.google.gwt.event.dom.client.KeyCodes;
import com.google.gwt.safehtml.client.SafeHtmlTemplates;
import com.google.gwt.safehtml.shared.SafeHtml;
import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
import com.google.gwt.safehtml.shared.SafeHtmlUtils;
import com.todomvc.client.command.CommandController;
import com.todomvc.shared.command.todo.AddOrRemoveToDoCommand;
import com.todomvc.shared.command.todo.SetCompletedToDoCommand;
import com.todomvc.shared.command.todo.SetTitleToDoCommand;
import com.todomvc.shared.model.ToDo;</code></pre></div></div><div id="section-1" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-1">1</a></span><div class="doctext"><p>A custom <a href="http://www.gwtproject.org/doc/latest/DevGuideUiCustomCells.html">Cell</a> that renders  an individual task.</p></div></div><div class="span6 code"><pre><code class="java">public class ToDoCell extends AbstractCell&lt;ToDo&gt; {</code></pre></div></div><div id="section-2" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-2">2</a></span><div class="doctext hidden-doc"></div></div><div class="span6 code"><div class="hidden-code-line">------------------<a href="javascript:void(0)" class="hidden-code-toggle" index="2">Show  Helper interface &amp; private fields  Code (<span class="linecount"></span> lines)</a>------------------</div><pre class="hidden-code"><code class="java">    interface Templates extends SafeHtmlTemplates {

        @SafeHtmlTemplates.Template(&quot;&lt;div class=&#39;{2}&#39; data-timestamp=&#39;{3}&#39;&gt;&quot; + &quot;{0} &quot;
                + &quot;&lt;label&gt;{1}&lt;/label&gt;&quot; + &quot;&lt;button class=&#39;destroy&#39;&gt;&lt;/a&gt;&quot; + &quot;&lt;/div&gt;&quot;)
        SafeHtml view(SafeHtml checked, SafeHtml task, String done, String timestamp);

        @SafeHtmlTemplates.Template(&quot;&lt;input class=&#39;toggle&#39; type=&#39;checkbox&#39; checked&gt;&quot;)
        SafeHtml inputChecked();

        @SafeHtmlTemplates.Template(&quot;&lt;input class=&#39;toggle&#39; type=&#39;checkbox&#39;&gt;&quot;)
        SafeHtml inputClear();

        @SafeHtmlTemplates.Template(&quot;&lt;div class=&#39;listItem editing&#39;&gt;&lt;input class=&#39;edit&#39; value=&#39;{0}&#39; type=&#39;text&#39;&gt;&lt;/div&gt;&quot;)
        SafeHtml edit(String task);
    }

    private static Templates templates = GWT.create(Templates.class);

    private ToDo editingItem = null;

    private boolean beginningEdit = false;</code></pre></div></div><div id="section-3" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-3">3</a></span><div class="doctext"><p>Dependencies. </p></div></div><div class="span6 code"><pre><code class="java">    private final CommandController commandController;
    private final ToDoPresenter presenter;

    public ToDoCell(ToDoPresenter presenter, CommandController commandController) {
        super(&quot;click&quot;, &quot;keyup&quot;, &quot;blur&quot;, &quot;dblclick&quot;);
        this.commandController = checkNotNull(commandController);
        this.presenter = checkNotNull(presenter);
    }</code></pre></div></div><div id="section-4" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-4">4</a></span><div class="doctext"><p>Render the cell in either edit or view mode. </p></div></div><div class="span6 code"><pre><code class="java">    @Override
    public void render(Context context, ToDo value, SafeHtmlBuilder sb) {
        if (isEditing(value)) {
            SafeHtml rendered = templates.edit(value.getTitle());
            sb.append(rendered);
        } else {
            SafeHtml rendered = templates.view(value.isCompleted() ? templates.inputChecked()
                    : templates.inputClear(), SafeHtmlUtils.fromString(value.getTitle()), value
                    .isCompleted() ? &quot;listItem view completed&quot; : &quot;listItem view&quot;,
                    // NOTE: The addition of a timestamp here is a bit of a HACK! The
                    // problem is that the CellList uses a HasDataPresenter for rendering.
                    // This class caches the more recent rendered contents for each cell, 
                    // skipping a render if it looks like the cell hasn&#39;t changed. However,
                    // this fails for editable cells that are able to change the DOM
                    // representation directly. This hack simply ensures that the presenter
                    // always renders the cell.
                    Long.toString(new Date().getTime()));
            sb.append(rendered);
        }
    }

    @Override
    public boolean isEditing(Context context, Element parent, ToDo value) {
        return isEditing(value);
    }

    @Override
    public void onBrowserEvent(Context context, Element parent, ToDo toDo, NativeEvent event,
            ValueUpdater&lt;ToDo&gt; valueUpdater) {

        String type = event.getType();

        if (isEditing(toDo)) {

            if (&quot;keyup&quot;.equals(type)) {
                int keyCode = event.getKeyCode();
                // handle enter key to commit the edit
                if (keyCode == KeyCodes.KEY_ENTER) {
                    commitEdit(parent, toDo);
                    endEdit(context, parent, toDo);
                }
                // handle escape key to cancel the edit
                if (keyCode == KeyCodes.KEY_ESCAPE) {
                    endEdit(context, parent, toDo);
                }
            }
            // handle blur event
            if (&quot;blur&quot;.equals(type) &amp;&amp; !beginningEdit) {
                commitEdit(parent, toDo);
                endEdit(context, parent, toDo);
            }

        } else {

            // handle double clicks to enter edit more
            if (&quot;dblclick&quot;.equals(type)) {
                beginEdit(context, parent, toDo);

                beginningEdit = true;
                InputElement input = getInputElement(parent);
                input.focus();
                beginningEdit = false;
            }

            // when not in edit mode - handle click events on the cell
            if (&quot;click&quot;.equals(type)) {

                EventTarget eventTarget = event.getEventTarget();
                Element clickedElement = Element.as(eventTarget);
                String tagName = clickedElement.getTagName();

                // check whether the checkbox was clicked
                if (tagName.equals(&quot;INPUT&quot;)) {

                    // if so, synchronize the model
                    InputElement input = clickedElement.cast();
                    Boolean completed = input.isChecked();
                    commandController.executeCommand(new SetCompletedToDoCommand(toDo, completed));

                    // update the &#39;row&#39; style
                    if (input.isChecked()) {
                        getViewRootElement(parent).addClassName(&quot;completed&quot;);
                    } else {
                        getViewRootElement(parent).removeClassName(&quot;completed&quot;);
                    }

                } else if (tagName.equals(&quot;BUTTON&quot;)) {
                    // if the delete anchor was clicked - delete the item
                    presenter.deleteTask(toDo);
                }
            }
        }

    }</code></pre></div></div><div id="section-5" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-5">5</a></span><div class="doctext"><p>On edit, execute a  <a href="../../../../java/com/todomvc/shared/command/todo/SetTitleToDoCommand.java.html">SetTitleToDoCommand</a>.</p></div></div><div class="span6 code"><pre><code class="java">    private void commitEdit(Element parent, ToDo toDo) {
        InputElement input = getInputElement(parent);
        String newTitle = input.getValue().trim();
        if (newTitle.isEmpty()) {
            presenter.deleteTask(toDo);
        } else if (!newTitle.equals(toDo.getTitle())) {
            commandController.executeCommand(new SetTitleToDoCommand(toDo, input.getValue()));
        }
    }</code></pre></div></div><div id="section-6" class="row-fluid docco-section"><div class="span6 doc"><span class="label label-info"><a style="color:white" href="#section-6">6</a></span><div class="doctext hidden-doc"></div></div><div class="span6 code"><div class="hidden-code-line">------------------<a href="javascript:void(0)" class="hidden-code-toggle" index="6">Show  Helper methods  Code (<span class="linecount"></span> lines)</a>------------------</div><pre class="hidden-code"><code class="java">    private void beginEdit(Context context, Element parent, ToDo value) {
        editingItem = value;
        renderCell(context, parent, value);
    }

    private void endEdit(Context context, Element parent, ToDo value) {
        editingItem = null;
        renderCell(context, parent, value);
    }

    private void renderCell(Context context, Element parent, ToDo value) {
        SafeHtmlBuilder sb = new SafeHtmlBuilder();
        render(context, value, sb);
        parent.setInnerHTML(sb.toSafeHtml().asString());
    }

    private boolean isEditing(ToDo item) {
        return editingItem == item;
    }

    private InputElement getInputElement(Element parent) {
        return parent.getFirstChild().getFirstChild().&lt;InputElement&gt; cast();
    }

    private DivElement getViewRootElement(Element parent) {
        return parent.getFirstChild().&lt;DivElement&gt; cast();
    }

}</code></pre></div></div></div><div id="grabber"></div></body></html>